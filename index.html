<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Evolution Research Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #333;
            --text-secondary: #666;
            --card-bg: rgba(255, 255, 255, 0.95);
            --accent-color: #667eea;
            --success-color: #4CAF50;
            --warning-color: #FFD700;
            --danger-color: #f44336;
            --evolution-glow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        [data-theme="dark"] {
            --primary-bg: linear-gradient(135deg, #2C3E50 0%, #34495E 100%);
            --secondary-bg: rgba(44, 62, 80, 0.95);
            --text-primary: #ECF0F1;
            --text-secondary: #BDC3C7;
            --card-bg: rgba(52, 73, 94, 0.95);
            --accent-color: #3498DB;
            --success-color: #27AE60;
            --warning-color: #F39C12;
            --danger-color: #E74C3C;
            --evolution-glow: 0 0 20px rgba(52, 152, 219, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-bg);
            min-height: 100vh;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--evolution-glow);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: linear-gradient(135deg, var(--accent-color), var(--success-color));
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: none;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--evolution-glow);
        }

        .mode-card.active {
            background: linear-gradient(135deg, var(--warning-color), var(--danger-color));
            box-shadow: var(--evolution-glow);
        }

        .game-area {
            position: relative;
            width: 100%;
            height: 400px;
            background: var(--primary-bg);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            transition: all 0.5s ease;
        }

        .game-area.evolved {
            box-shadow: var(--evolution-glow);
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4);
            background-size: 400% 400%;
            animation: evolutionBackground 8s ease infinite;
        }

        @keyframes evolutionBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .target {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .target:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .target.normal {
            background: var(--success-color);
        }

        .target.powerup {
            background: var(--warning-color);
            box-shadow: 0 0 15px var(--warning-color);
            animation: powerupPulse 1s ease-in-out infinite alternate;
        }

        .target.negative {
            background: var(--danger-color);
        }

        .target.square {
            border-radius: 10%;
        }

        .target.hexagon {
            clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%);
            border-radius: 0;
        }

        .target.pentagon {
            clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
            border-radius: 0;
        }

        .target.triangle {
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            border-radius: 0;
        }

        .target.diamond {
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            border-radius: 0;
        }

        @keyframes powerupPulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--accent-color), var(--success-color));
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--evolution-glow);
        }

        .achievement-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--success-color), var(--accent-color));
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: transform 0.5s ease;
            z-index: 1000;
        }

        .achievement-popup.show {
            transform: translateX(0);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .setting-group {
            background: rgba(0, 0, 0, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        [data-theme="dark"] .setting-group {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), var(--success-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--evolution-glow);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--warning-color), var(--danger-color));
            color: white;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .chart-card {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .evolution-status {
            background: linear-gradient(135deg, var(--warning-color), var(--danger-color));
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .evolution-status.evolved {
            animation: evolutionGlow 2s ease-in-out infinite alternate;
        }

        @keyframes evolutionGlow {
            from { box-shadow: var(--evolution-glow); }
            to { box-shadow: 0 0 30px var(--warning-color); }
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .data-export {
            margin-top: 20px;
            text-align: center;
        }

        .start-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-direction: column;
            color: white;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        select {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        label {
            display: block;
            margin: 10px 0;
            font-weight: 500;
        }

        .color-picker {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .sound-visualizer {
            height: 30px;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            border-radius: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .frequency-indicator {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, var(--warning-color) 50%, transparent 100%);
            border-radius: 15px;
            transform-origin: left;
            transform: scaleX(0);
            transition: transform 0.1s ease;
        }

        .background-preview {
            width: 100%;
            height: 60px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid var(--accent-color);
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <div class="card">
            <div class="game-header">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                    ðŸŒ“
                </button>
                <h1 class="game-title">Game Evolution Research Platform</h1>
                <p>A scientific study of adaptive gameplay mechanics with enhanced sensory feedback</p>
            </div>

            <!-- Mode Selector -->
            <div class="mode-selector">
                <button class="mode-card" onclick="selectMode('simple')">
                    <h3>Simple Mode</h3>
                    <p>Basic click targets (v1 enhanced)</p>
                </button>
                <button class="mode-card active" onclick="selectMode('classic')">
                    <h3>Classic Evolution</h3>
                    <p>Progressive complexity with mutations</p>
                </button>
                <button class="mode-card" onclick="selectMode('experimental')">
                    <h3>Experimental Evolution</h3>
                    <p>Rapid adaptation with full sensory feedback</p>
                </button>
                <button class="mode-card" onclick="selectMode('research')">
                    <h3>Research Mode</h3>
                    <p>Maximum data collection</p>
                </button>
            </div>

            <!-- Evolution Status -->
            <div class="evolution-status" id="evolutionStatus">
                Game Evolution Engine: CLASSIC Mode Ready
            </div>

            <!-- Stats Panel -->
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-value" id="score">0</div>
                    <div class="stat-label">Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="level">1</div>
                    <div class="stat-label">Evolution Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="accuracy">100%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="adaptations">0</div>
                    <div class="stat-label">Mutations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="efficiency">0</div>
                    <div class="stat-label">Efficiency</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="harmony">C4</div>
                    <div class="stat-label">Harmony</div>
                </div>
            </div>

            <!-- Game Area -->
            <div class="game-area" id="gameArea">
                <div id="startScreen" class="start-screen">
                    <h2 style="margin-bottom: 20px;">Ready to contribute to science?</h2>
                    <p style="margin-bottom: 20px;">Experience adaptive gameplay with visual and auditory evolution</p>
                    <button class="btn btn-primary" onclick="startGame()">Start Evolution Experiment</button>
                </div>
            </div>

            <!-- Sound Visualizer -->
            <div class="sound-visualizer">
                <div class="frequency-indicator" id="frequencyIndicator"></div>
            </div>

            <!-- Control Buttons -->
            <div class="controls">
                <button class="btn btn-primary" onclick="startGame()" id="startBtn">Start Game</button>
                <button class="btn btn-primary" onclick="pauseGame()" id="pauseBtn" style="display: none;">Pause</button>
                <button class="btn btn-primary" onclick="resetGame()">Reset</button>
                <button class="btn btn-primary" onclick="showSettings()">Settings</button>
                <button class="btn btn-primary" onclick="showAchievements()">Achievements</button>
                <button class="btn btn-primary" onclick="showChallenges()">Challenges</button>
            </div>

            <!-- Data Export -->
            <div class="data-export">
                <h3>Research Data Export</h3>
                <button class="btn btn-secondary" onclick="exportData('csv')">Export CSV</button>
                <button class="btn btn-secondary" onclick="exportData('json')">Export JSON</button>
                <button class="btn btn-secondary" onclick="generateReport()">Generate Report</button>
            </div>

            <!-- Charts Container -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Performance Over Time</h3>
                    <canvas id="performanceChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Evolution Adaptations</h3>
                    <canvas id="evolutionChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Player Behavior Analysis</h3>
                    <canvas id="behaviorChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievementPopup">
        <h3 id="achievementTitle">Achievement Unlocked!</h3>
        <p id="achievementDesc">Description here</p>
    </div>

    <!-- Enhanced Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2>Enhanced Research Settings</h2>
            <div class="settings-grid">
                <div class="setting-group">
                    <h3>Evolution Features</h3>
                    <label>
                        <input type="checkbox" id="enableShapeMutation" checked> Shape Mutations
                    </label>
                    <label>
                        <input type="checkbox" id="enableColorEvolution" checked> Color Evolution
                    </label>
                    <label>
                        <input type="checkbox" id="enableSoundEffects" checked> Harmonic Sound Effects
                    </label>
                    <label>
                        <input type="checkbox" id="enableBackgroundAnimation" checked> Background Animation
                    </label>
                </div>

                <div class="setting-group">
                    <h3>Audio Settings</h3>
                    <label>Master Volume:</label>
                    <input type="range" id="masterVolume" min="0" max="1" step="0.1" value="0.3">
                    <span id="volumeValue">30%</span>
                    
                    <label>Base Frequency (Hz):</label>
                    <input type="range" id="baseFrequency" min="200" max="800" step="50" value="440">
                    <span id="frequencyValue">440 Hz</span>
                    
                    <label>Harmonic Scale:</label>
                    <select id="harmonicScale">
                        <option value="major">Major</option>
                        <option value="minor">Minor</option>
                        <option value="pentatonic">Pentatonic</option>
                        <option value="chromatic">Chromatic</option>
                    </select>
                </div>

                <div class="setting-group">
                    <h3>Visual Settings</h3>
                    <label>Background Color:</label>
                    <input type="color" id="backgroundColor" class="color-picker" value="#667eea">
                    <div class="background-preview" id="backgroundPreview"></div>
                    
                    <label>Target Color Palette:</label>
                    <select id="colorPalette">
                        <option value="default">Default</option>
                        <option value="warm">Warm</option>
                        <option value="cool">Cool</option>
                        <option value="neon">Neon</option>
                        <option value="pastel">Pastel</option>
                        <option value="rainbow">Rainbow</option>
                    </select>
                </div>

                <div class="setting-group">
                    <h3>Performance</h3>
                    <label>Evolution Speed:</label>
                    <input type="range" id="evolutionSpeed" min="0.5" max="3" step="0.1" value="1">
                    <span id="evolutionSpeedValue">1x</span>
                    
                    <label>Data Collection:</label>
                    <select id="dataFrequency">
                        <option value="low">Low (every 5s)</option>
                        <option value="medium" selected>Medium (every 2s)</option>
                        <option value="high">High (every 0.5s)</option>
                    </select>
                    
                    <label>
                        <input type="checkbox" id="experimentalMode"> Enable Rapid Evolution
                    </label>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="resetSettings()">Reset to Defaults</button>
                <button class="btn btn-primary" onclick="closeSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal" id="achievementsModal">
        <div class="modal-content">
            <h2>Achievements</h2>
            <div id="achievementsList"></div>
            <button class="btn btn-primary" onclick="closeAchievements()">Close</button>
        </div>
    </div>

    <!-- Challenges Modal -->
    <div class="modal" id="challengesModal">
        <div class="modal-content">
            <h2>Research Challenges</h2>
            <div id="challengesList"></div>
            <button class="btn btn-primary" onclick="closeChallenges()">Close</button>
        </div>
    </div>

    <script>
        // Enhanced Game State Management
        var gameState = {
            isPlaying: false,
            mode: 'classic',
            score: 0,
            level: 1,
            targets: [],
            features: [],
            evolutionData: [],
            achievements: [],
            completedChallenges: [],
            sessionData: {
                startTime: null,
                clicks: [],
                adaptations: [],
                performanceMetrics: []
            },
            stats: {
                totalClicks: 0,
                successfulHits: 0,
                missedTargets: 0,
                accuracy: 100,
                avgReactionTime: 0,
                efficiency: 0
            },
            audio: {
                context: null,
                currentNote: 'C4',
                harmonicScale: 'major',
                baseFrequency: 440
            },
            visual: {
                colorPalette: 'default',
                shapeMutations: true,
                colorEvolution: true,
                backgroundAnimation: true
            }
        };

        // Enhanced Evolution Rules
        var EVOLUTION_RULES = {
            simple: [
                { level: 2, feature: 'color_variation', threshold: 15 },
                { level: 3, feature: 'shape_mutation', threshold: 30 },
                { level: 4, feature: 'sound_feedback', threshold: 50 }
            ],
            classic: [
                { level: 2, feature: 'multiple_targets', threshold: 10 },
                { level: 3, feature: 'color_variation', threshold: 25 },
                { level: 4, feature: 'shape_mutation', threshold: 40 },
                { level: 5, feature: 'moving_targets', threshold: 60 },
                { level: 6, feature: 'sound_harmony', threshold: 80 },
                { level: 7, feature: 'size_variation', threshold: 110 },
                { level: 8, feature: 'power_ups', threshold: 140 },
                { level: 9, feature: 'negative_targets', threshold: 180 },
                { level: 10, feature: 'background_evolution', threshold: 220 }
            ],
            experimental: [
                { level: 2, feature: 'adaptive_colors', threshold: 5 },
                { level: 3, feature: 'shape_morphing', threshold: 12 },
                { level: 4, feature: 'sound_synthesis', threshold: 20 },
                { level: 5, feature: 'predictive_spawning', threshold: 30 },
                { level: 6, feature: 'neural_patterns', threshold: 45 },
                { level: 7, feature: 'harmonic_resonance', threshold: 60 },
                { level: 8, feature: 'visual_synthesis', threshold: 80 }
            ],
            research: [
                { level: 2, feature: 'data_visualization', threshold: 8 },
                { level: 3, feature: 'behavior_tracking', threshold: 15 },
                { level: 4, feature: 'pattern_analysis', threshold: 25 },
                { level: 5, feature: 'cognitive_mapping', threshold: 40 }
            ]
        };

        // Enhanced Color Palettes
        var COLOR_PALETTES = {
            default: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336'],
            warm: ['#FF6B6B', '#FF8E53', '#FF6B9D', '#C44569', '#F8B500'],
            cool: ['#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'],
            neon: ['#FF073A', '#39FF14', '#00FFFF', '#FF1493', '#FFFF00'],
            pastel: ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF'],
            rainbow: ['#FF0000', '#FF8000', '#FFFF00', '#00FF00', '#0000FF', '#8000FF']
        };

        // Musical scales for harmony
        var HARMONIC_SCALES = {
            major: [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88], // C Major
            minor: [261.63, 293.66, 311.13, 349.23, 392.00, 415.30, 466.16], // C Minor
            pentatonic: [261.63, 293.66, 329.63, 392.00, 440.00], // C Pentatonic
            chromatic: [261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88]
        };

        // Shape variations
        var SHAPE_TYPES = ['circle', 'square', 'hexagon', 'pentagon', 'triangle', 'diamond'];

        var ACHIEVEMENTS = {
            firstClick: { name: "First Steps", desc: "Click your first target", points: 10 },
            quickReflexes: { name: "Quick Reflexes", desc: "React in under 300ms", points: 25 },
            sharpshooter: { name: "Sharpshooter", desc: "Achieve 95% accuracy", points: 50 },
            colorMaster: { name: "Color Master", desc: "Experience all color variations", points: 75 },
            shapeshifter: { name: "Shapeshifter", desc: "Hit targets of all shapes", points: 100 },
            harmonist: { name: "Harmonist", desc: "Reach harmonic resonance", points: 125 },
            evolutionist: { name: "Evolutionist", desc: "Unlock 8 features", points: 150 },
            scientist: { name: "Scientist", desc: "Generate 200 data points", points: 200 },
            synthMaster: { name: "Synthesis Master", desc: "Master visual-audio synthesis", points: 300 }
        };

        var charts = {};
        var spawnInterval;
        var dataInterval;
        var audioContext;
        var settings = {
            shapeMutation: true,
            colorEvolution: true,
            soundEffects: true,
            backgroundAnimation: true,
            masterVolume: 0.3,
            baseFrequency: 440,
            harmonicScale: 'major',
            colorPalette: 'default',
            evolutionSpeed: 1
        };

        // Theme Management
        function toggleTheme() {
            var currentTheme = document.body.getAttribute('data-theme');
            var newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateCharts();
        }

        // Audio System
        function initializeAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gameState.audio.context = audioContext;
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playHarmonicTone(frequency, duration = 200) {
            if (!audioContext || !settings.soundEffects) return;
            
            var oscillator = audioContext.createOscillator();
            var gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(settings.masterVolume, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
            
            updateFrequencyVisualizer(frequency);
        }

        function getHarmonicFrequency(level, targetType) {
            var scale = HARMONIC_SCALES[settings.harmonicScale];
            var baseIndex = Math.min(level - 1, scale.length - 1);
            var frequency = scale[baseIndex];
            
            if (targetType === 'powerup') frequency *= 1.5;
            if (targetType === 'negative') frequency *= 0.75;
            
            return frequency;
        }

        function updateFrequencyVisualizer(frequency) {
            var indicator = document.getElementById('frequencyIndicator');
            var maxFreq = 800;
            var scale = Math.min(frequency / maxFreq, 1);
            indicator.style.transform = 'scaleX(' + scale + ')';
            
            setTimeout(function() {
                indicator.style.transform = 'scaleX(0)';
            }, 200);
        }

        // Enhanced Visual System
        function getEvolutionColor(level, targetType, baseColor) {
            if (!settings.colorEvolution) return baseColor;
            
            var palette = COLOR_PALETTES[settings.colorPalette];
            var colorIndex = (level - 1) % palette.length;
            var color = palette[colorIndex];
            
            if (targetType === 'powerup') {
                return '#FFD700'; // Gold for powerups
            } else if (targetType === 'negative') {
                return '#FF4444'; // Red for negative
            }
            
            return color;
        }

        function getEvolutionShape(level) {
            if (!settings.shapeMutation) return 'circle';
            
            if (gameState.features.indexOf('shape_mutation') === -1) return 'circle';
            
            var shapeIndex = Math.min(Math.floor(level / 2), SHAPE_TYPES.length - 1);
            return SHAPE_TYPES[shapeIndex];
        }

        function updateBackgroundEvolution() {
            var gameArea = document.getElementById('gameArea');
            if (settings.backgroundAnimation && gameState.features.indexOf('background_evolution') !== -1) {
                gameArea.classList.add('evolved');
            } else {
                gameArea.classList.remove('evolved');
            }
        }

        // Game Mode Selection
        function selectMode(mode) {
            document.querySelectorAll('.mode-card').forEach(function(card) {
                card.classList.remove('active');
            });
            event.target.closest('.mode-card').classList.add('active');
            
            gameState.mode = mode;
            updateEvolutionStatus();
            
            if (gameState.isPlaying) {
                resetGame();
            }
        }

        // Enhanced Game Control Functions
        function startGame() {
            if (!audioContext) initializeAudio();
            
            gameState.isPlaying = true;
            gameState.sessionData.startTime = Date.now();
            gameState.score = 0;
            gameState.level = 1;
            gameState.targets = [];
            gameState.features = [];
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            
            spawnTarget();
            startDataCollection();
            updateUI();
        }

        function pauseGame() {
            gameState.isPlaying = false;
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            
            if (spawnInterval) clearTimeout(spawnInterval);
            if (dataInterval) clearInterval(dataInterval);
        }

        function resetGame() {
            gameState.isPlaying = false;
            gameState.score = 0;
            gameState.level = 1;
            gameState.targets = [];
            gameState.features = [];
            gameState.stats = {
                totalClicks: 0,
                successfulHits: 0,
                missedTargets: 0,
                accuracy: 100,
                avgReactionTime: 0,
                efficiency: 0
            };
            
            var gameArea = document.getElementById('gameArea');
            var targets = gameArea.querySelectorAll('.target');
            targets.forEach(function(target) {
                target.remove();
            });
            
            gameArea.classList.remove('evolved');
            document.getElementById('startScreen').style.display = 'flex';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            
            if (spawnInterval) clearTimeout(spawnInterval);
            if (dataInterval) clearInterval(dataInterval);
            
            updateUI();
        }

        // Enhanced Target Management
        function createTarget() {
            var gameArea = document.getElementById('gameArea');
            
            var target = {
                id: Math.random().toString(36).substr(2, 9),
                x: Math.random() * (400 - 60) + 30,
                y: Math.random() * (400 - 60) + 30,
                size: calculateTargetSize(),
                type: calculateTargetType(),
                shape: getEvolutionShape(gameState.level),
                color: null, // Will be set during rendering
                speed: calculateTargetSpeed(),
                spawnTime: Date.now(),
                clicked: false
            };

            return target;
        }

        function renderTarget(target) {
            var targetElement = document.createElement('div');
            var baseClass = 'target ' + target.type + ' ' + target.shape;
            targetElement.className = baseClass;
            targetElement.id = 'target-' + target.id;
            targetElement.style.left = target.x + 'px';
            targetElement.style.top = target.y + 'px';
            targetElement.style.width = target.size + 'px';
            targetElement.style.height = target.size + 'px';
            
            // Apply evolution color
            var color = getEvolutionColor(gameState.level, target.type, '#4CAF50');
            target.color = color;
            targetElement.style.background = color;
            
            targetElement.addEventListener('click', function(e) {
                handleTargetClick(target, e);
            });
            
            document.getElementById('gameArea').appendChild(targetElement);

            setTimeout(function() {
                if (!target.clicked) {
                    removeTarget(target.id);
                    gameState.stats.missedTargets++;
                    collectDataPoint('target_missed', { 
                        targetId: target.id, 
                        lifespan: Date.now() - target.spawnTime 
                    });
                }
            }, 5000);

            if (target.speed > 0) {
                animateTarget(target, targetElement);
            }
        }

        function handleTargetClick(target, event) {
            if (target.clicked) return;
            
            target.clicked = true;
            var reactionTime = Date.now() - target.spawnTime;
            
            gameState.stats.totalClicks++;
            gameState.stats.successfulHits++;
            gameState.stats.avgReactionTime = gameState.stats.avgReactionTime === 0 ? 
                reactionTime : (gameState.stats.avgReactionTime + reactionTime) / 2;
            
            var points = 1;
            if (target.type === 'powerup') points = 5;
            if (target.type === 'negative') points = -2;
            
            if (reactionTime < 300) points *= 2;
            else if (reactionTime < 500) points *= 1.5;
            
            gameState.score += Math.max(points, 0);
            
            // Play harmonic sound
            var frequency = getHarmonicFrequency(gameState.level, target.type);
            playHarmonicTone(frequency);
            
            // Update current note display
            var noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            var octave = Math.floor(Math.log2(frequency / 261.63)) + 4;
            var noteIndex = Math.round(12 * Math.log2(frequency / 261.63)) % 12;
            gameState.audio.currentNote = noteNames[noteIndex] + octave;
            
            collectDataPoint('target_clicked', {
                targetId: target.id,
                reactionTime: reactionTime,
                targetType: target.type,
                targetSize: target.size,
                targetShape: target.shape,
                targetColor: target.color,
                score: points,
                frequency: frequency,
                note: gameState.audio.currentNote,
                accuracy: gameState.stats.successfulHits / gameState.stats.totalClicks
            });
            
            showClickFeedback(event.clientX, event.clientY, points);
            removeTarget(target.id);
            
            checkEvolution();
            checkAchievements();
            updateUI();
        }

        // [Previous functions remain the same but with enhanced features]
        function spawnTarget() {
            if (!gameState.isPlaying) return;

            var target = createTarget();
            gameState.targets.push(target);
            renderTarget(target);

            var spawnDelay = calculateSpawnDelay();
            spawnInterval = setTimeout(function() {
                if (gameState.isPlaying) spawnTarget();
            }, spawnDelay);
        }

        function calculateTargetSize() {
            var baseSize = 40;
            if (gameState.features.indexOf('size_variation') !== -1) {
                baseSize = 20 + Math.random() * 40;
            }
            return baseSize;
        }

        function calculateTargetType() {
            if (gameState.features.indexOf('power_ups') !== -1 && Math.random() < 0.2) return 'powerup';
            if (gameState.features.indexOf('negative_targets') !== -1 && Math.random() < 0.15) return 'negative';
            return 'normal';
        }

        function calculateTargetSpeed() {
            var speed = 0;
            if (gameState.features.indexOf('moving_targets') !== -1) speed = 1;
            if (gameState.features.indexOf('adaptive_speed') !== -1) speed = Math.min(gameState.level * 0.2, 3);
            return speed;
        }

        function calculateSpawnDelay() {
            var baseDelay = 2000;
            if (gameState.features.indexOf('multiple_targets') !== -1) baseDelay = 1000;
            if (gameState.mode === 'experimental') baseDelay *= 0.7;
            return Math.max(baseDelay - (gameState.level * 50), 500);
        }

        function animateTarget(target, element) {
            var dx = (Math.random() - 0.5) * target.speed * 2;
            var dy = (Math.random() - 0.5) * target.speed * 2;
            
            function move() {
                if (!element.parentNode || !gameState.isPlaying) return;
                
                target.x += dx;
                target.y += dy;
                
                if (target.x <= 0 || target.x >= 360) dx = -dx;
                if (target.y <= 0 || target.y >= 360) dy = -dy;
                
                element.style.left = target.x + 'px';
                element.style.top = target.y + 'px';
                
                requestAnimationFrame(move);
            }
            
            requestAnimationFrame(move);
        }

        function removeTarget(targetId) {
            var element = document.getElementById('target-' + targetId);
            if (element) element.remove();
            gameState.targets = gameState.targets.filter(function(t) {
                return t.id !== targetId;
            });
        }

        function showClickFeedback(x, y, points) {
            var feedback = document.createElement('div');
            feedback.textContent = points > 0 ? '+' + points : points;
            feedback.style.position = 'fixed';
            feedback.style.left = x + 'px';
            feedback.style.top = y + 'px';
            feedback.style.color = points > 0 ? '#4CAF50' : '#f44336';
            feedback.style.fontWeight = 'bold';
            feedback.style.fontSize = '20px';
            feedback.style.pointerEvents = 'none';
            feedback.style.zIndex = '1000';
            feedback.style.transition = 'all 1s ease';
            
            document.body.appendChild(feedback);
            
            setTimeout(function() {
                feedback.style.transform = 'translateY(-50px)';
                feedback.style.opacity = '0';
            }, 100);
            
            setTimeout(function() {
                if (feedback.parentNode) feedback.remove();
            }, 1100);
        }

        // Enhanced Evolution System
        function checkEvolution() {
            var rules = EVOLUTION_RULES[gameState.mode] || EVOLUTION_RULES.classic;
            var currentRule = null;
            
            for (var i = 0; i < rules.length; i++) {
                var rule = rules[i];
                if (rule.level === gameState.level + 1 && 
                    gameState.score >= rule.threshold &&
                    gameState.features.indexOf(rule.feature) === -1) {
                    currentRule = rule;
                    break;
                }
            }
            
            if (currentRule) {
                gameState.level++;
                gameState.features.push(currentRule.feature);
                
                var adaptation = {
                    timestamp: Date.now(),
                    level: gameState.level,
                    feature: currentRule.feature,
                    score: gameState.score,
                    sessionTime: Date.now() - gameState.sessionData.startTime
                };
                
                gameState.sessionData.adaptations.push(adaptation);
                collectDataPoint('evolution', adaptation);
                
                showEvolutionNotification(currentRule.feature);
                updateEvolutionStatus();
                updateBackgroundEvolution();
                
                // Play evolution sound
                var frequency = getHarmonicFrequency(gameState.level, 'powerup');
                playHarmonicTone(frequency, 500);
            }
        }

        function showEvolutionNotification(feature) {
            var notification = document.createElement('div');
            notification.className = 'evolution-status pulsing';
            notification.textContent = 'EVOLUTION: ' + feature.replace(/_/g, ' ').toUpperCase() + ' UNLOCKED!';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.zIndex = '1000';
            notification.style.animation = 'evolutionGlow 1s ease-in-out infinite alternate';
            
            document.body.appendChild(notification);
            
            setTimeout(function() {
                if (notification.parentNode) notification.remove();
            }, 4000);
        }

        // Enhanced Achievement System
        function checkAchievements() {
            Object.keys(ACHIEVEMENTS).forEach(function(key) {
                var achievement = ACHIEVEMENTS[key];
                if (gameState.achievements.indexOf(key) !== -1) return;
                
                var unlocked = false;
                
                switch(key) {
                    case 'firstClick':
                        unlocked = gameState.stats.successfulHits >= 1;
                        break;
                    case 'quickReflexes':
                        unlocked = gameState.stats.avgReactionTime < 300 && gameState.stats.successfulHits > 5;
                        break;
                    case 'sharpshooter':
                        unlocked = (gameState.stats.successfulHits / gameState.stats.totalClicks * 100) >= 95 && gameState.stats.totalClicks > 20;
                        break;
                    case 'colorMaster':
                        unlocked = gameState.features.indexOf('color_variation') !== -1;
                        break;
                    case 'shapeshifter':
                        unlocked = gameState.features.indexOf('shape_mutation') !== -1;
                        break;
                    case 'harmonist':
                        unlocked = gameState.features.indexOf('sound_harmony') !== -1;
                        break;
                    case 'evolutionist':
                        unlocked = gameState.features.length >= 8;
                        break;
                    case 'scientist':
                        unlocked = gameState.evolutionData.length >= 200;
                        break;
                    case 'synthMaster':
                        unlocked = gameState.features.indexOf('visual_synthesis') !== -1;
                        break;
                }
                
                if (unlocked) {
                    gameState.achievements.push(key);
                    showAchievement(achievement);
                    collectDataPoint('achievement', { 
                        achievementId: key,
                        name: achievement.name,
                        desc: achievement.desc,
                        points: achievement.points
                    });
                }
            });
        }

        function showAchievement(achievement) {
            var popup = document.getElementById('achievementPopup');
            document.getElementById('achievementTitle').textContent = achievement.name;
            document.getElementById('achievementDesc').textContent = achievement.desc;
            
            popup.classList.add('show');
            setTimeout(function() {
                popup.classList.remove('show');
            }, 4000);
        }

        // Enhanced UI Updates
        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('level').textContent = gameState.level;
            var accuracy = gameState.stats.totalClicks > 0 ? 
                (gameState.stats.successfulHits / gameState.stats.totalClicks) * 100 : 100;
            document.getElementById('accuracy').textContent = Math.round(accuracy) + '%';
            document.getElementById('adaptations').textContent = gameState.sessionData.adaptations.length;
            document.getElementById('efficiency').textContent = 
                Math.round(gameState.score / Math.max(gameState.stats.totalClicks, 1));
            document.getElementById('harmony').textContent = gameState.audio.currentNote;
            
            updateCharts();
        }

        function updateEvolutionStatus() {
            var status = document.getElementById('evolutionStatus');
            var features = gameState.features;
            
            if (features.length === 0) {
                status.textContent = gameState.mode.toUpperCase() + ' Mode: Ready for evolution';
                status.classList.remove('evolved');
            } else {
                status.textContent = gameState.mode.toUpperCase() + ' Mode: ' + features.length + ' mutations active';
                status.classList.add('evolved');
            }
        }

        // Enhanced Settings System
        function showSettings() {
            // Update UI with current settings
            document.getElementById('enableShapeMutation').checked = settings.shapeMutation;
            document.getElementById('enableColorEvolution').checked = settings.colorEvolution;
            document.getElementById('enableSoundEffects').checked = settings.soundEffects;
            document.getElementById('enableBackgroundAnimation').checked = settings.backgroundAnimation;
            document.getElementById('masterVolume').value = settings.masterVolume;
            document.getElementById('volumeValue').textContent = Math.round(settings.masterVolume * 100) + '%';
            document.getElementById('baseFrequency').value = settings.baseFrequency;
            document.getElementById('frequencyValue').textContent = settings.baseFrequency + ' Hz';
            document.getElementById('harmonicScale').value = settings.harmonicScale;
            document.getElementById('colorPalette').value = settings.colorPalette;
            document.getElementById('evolutionSpeed').value = settings.evolutionSpeed;
            document.getElementById('evolutionSpeedValue').textContent = settings.evolutionSpeed + 'x';
            
            updateBackgroundPreview();
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            // Save settings
            settings.shapeMutation = document.getElementById('enableShapeMutation').checked;
            settings.colorEvolution = document.getElementById('enableColorEvolution').checked;
            settings.soundEffects = document.getElementById('enableSoundEffects').checked;
            settings.backgroundAnimation = document.getElementById('enableBackgroundAnimation').checked;
            settings.masterVolume = parseFloat(document.getElementById('masterVolume').value);
            settings.baseFrequency = parseInt(document.getElementById('baseFrequency').value);
            settings.harmonicScale = document.getElementById('harmonicScale').value;
            settings.colorPalette = document.getElementById('colorPalette').value;
            settings.evolutionSpeed = parseFloat(document.getElementById('evolutionSpeed').value);
            
            localStorage.setItem('gameSettings', JSON.stringify(settings));
            document.getElementById('settingsModal').style.display = 'none';
            
            updateBackgroundEvolution();
        }

        function resetSettings() {
            settings = {
                shapeMutation: true,
                colorEvolution: true,
                soundEffects: true,
                backgroundAnimation: true,
                masterVolume: 0.3,
                baseFrequency: 440,
                harmonicScale: 'major',
                colorPalette: 'default',
                evolutionSpeed: 1
            };
            showSettings(); // Refresh the UI
        }

        function updateBackgroundPreview() {
            var preview = document.getElementById('backgroundPreview');
            var color = document.getElementById('backgroundColor').value;
            preview.style.background = 'linear-gradient(135deg, ' + color + ', #764ba2)';
        }

        // [Previous functions for data collection, charts, modals, etc. remain the same]
        function collectDataPoint(type, data) {
            var dataPoint = {
                timestamp: Date.now(),
                sessionTime: Date.now() - (gameState.sessionData.startTime || Date.now()),
                type: type,
                gameMode: gameState.mode,
                level: gameState.level,
                score: gameState.score,
                features: gameState.features.slice(),
                settings: Object.assign({}, settings)
            };
            
            if (data) {
                Object.keys(data).forEach(function(key) {
                    dataPoint[key] = data[key];
                });
            }
            
            gameState.evolutionData.push(dataPoint);
        }

        function startDataCollection() {
            dataInterval = setInterval(function() {
                if (gameState.isPlaying) {
                    collectDataPoint('performance_metric', {
                        accuracy: gameState.stats.successfulHits / Math.max(gameState.stats.totalClicks, 1),
                        avgReactionTime: gameState.stats.avgReactionTime,
                        targetsActive: gameState.targets.length,
                        efficiency: gameState.score / Math.max(gameState.stats.totalClicks, 1),
                        currentNote: gameState.audio.currentNote
                    });
                }
            }, 2000);
        }

        // [Previous chart, modal, and export functions remain the same but should be included...]
        function initializeCharts() {
            var perfCtx = document.getElementById('performanceChart').getContext('2d');
            charts.performance = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Score',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Accuracy %',
                        data: [],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            var evolCtx = document.getElementById('evolutionChart').getContext('2d');
            charts.evolution = new Chart(evolCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Adaptations',
                        data: [],
                        backgroundColor: 'rgba(76, 175, 80, 0.8)',
                        borderColor: '#4CAF50',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            var behavCtx = document.getElementById('behaviorChart').getContext('2d');
            charts.behavior = new Chart(behavCtx, {
                type: 'radar',
                data: {
                    labels: ['Speed', 'Accuracy', 'Consistency', 'Adaptability', 'Efficiency'],
                    datasets: [{
                        label: 'Player Profile',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgb(255, 99, 132)',
                        pointBackgroundColor: 'rgb(255, 99, 132)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(255, 99, 132)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (!gameState.evolutionData.length) return;

            var recent = gameState.evolutionData.slice(-20);
            var performanceData = recent.filter(function(d) {
                return d.type === 'performance_metric';
            });
            
            if (performanceData.length > 0) {
                charts.performance.data.labels = performanceData.map(function(_, i) {
                    return i;
                });
                charts.performance.data.datasets[0].data = performanceData.map(function(d) {
                    return d.score;
                });
                charts.performance.data.datasets[1].data = performanceData.map(function(d) {
                    return d.accuracy * 100;
                });
                charts.performance.update();
            }

            var adaptations = gameState.sessionData.adaptations;
            if (adaptations.length > 0) {
                charts.evolution.data.labels = adaptations.map(function(a) {
                    return a.feature.replace(/_/g, ' ');
                });
                charts.evolution.data.datasets[0].data = adaptations.map(function(_, i) {
                    return i + 1;
                });
                charts.evolution.update();
            }

            var recentPerf = performanceData.slice(-5);
            if (recentPerf.length > 0) {
                var avgAccuracy = recentPerf.reduce(function(sum, d) {
                    return sum + d.accuracy;
                }, 0) / recentPerf.length * 100;
                var avgSpeed = Math.max(0, 100 - (gameState.stats.avgReactionTime / 10));
                var consistency = Math.max(0, 100 - Math.abs(avgAccuracy - 95));
                var adaptability = Math.min(100, gameState.features.length * 12);
                var efficiency = Math.min(100, (recentPerf[recentPerf.length - 1].efficiency || 0) * 10);

                charts.behavior.data.datasets[0].data = [avgSpeed, avgAccuracy, consistency, adaptability, efficiency];
                charts.behavior.update();
            }
        }

        // [Include all previous modal functions, data export functions, etc.]
        function showAchievements() {
            var modal = document.getElementById('achievementsModal');
            var list = document.getElementById('achievementsList');
            
            var html = '';
            if (gameState.achievements.length === 0) {
                html = '<p>No achievements unlocked yet. Keep evolving!</p>';
            } else {
                gameState.achievements.forEach(function(achievementId) {
                    var achievement = ACHIEVEMENTS[achievementId];
                    if (achievement) {
                        html += '<div style="margin: 10px 0; padding: 15px; background: linear-gradient(135deg, var(--accent-color), var(--success-color)); color: white; border-radius: 10px;">';
                        html += '<strong>' + achievement.name + '</strong><br>';
                        html += achievement.desc + '<br>';
                        html += '<small>Points: ' + achievement.points + '</small>';
                        html += '</div>';
                    }
                });
            }
            
            list.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closeAchievements() {
            document.getElementById('achievementsModal').style.display = 'none';
        }

        function showChallenges() {
            document.getElementById('challengesModal').style.display = 'flex';
        }

        function closeChallenges() {
            document.getElementById('challengesModal').style.display = 'none';
        }

        // Data Export Functions
        function exportData(format) {
            var sessionDuration = Date.now() - (gameState.sessionData.startTime || Date.now());
            var data = {
                sessionInfo: {
                    mode: gameState.mode,
                    duration: sessionDuration,
                    finalScore: gameState.score,
                    maxLevel: gameState.level,
                    featuresUnlocked: gameState.features.slice(),
                    settings: settings
                },
                evolutionData: gameState.evolutionData,
                adaptations: gameState.sessionData.adaptations,
                achievements: gameState.achievements.slice(),
                stats: gameState.stats
            };

            if (format === 'csv') {
                exportCSV(data);
            } else if (format === 'json') {
                exportJSON(data);
            }
        }

        function exportCSV(data) {
            var headers = ['timestamp', 'type', 'gameMode', 'level', 'score', 'accuracy', 'reactionTime', 'feature', 'targetShape', 'targetColor', 'frequency', 'note'];
            var rows = data.evolutionData.map(function(point) {
                return [
                    new Date(point.timestamp).toISOString(),
                    point.type,
                    point.gameMode,
                    point.level,
                    point.score,
                    point.accuracy || '',
                    point.reactionTime || '',
                    point.feature || '',
                    point.targetShape || '',
                    point.targetColor || '',
                    point.frequency || '',
                    point.note || ''
                ];
            });

            var csvContent = [headers].concat(rows).map(function(row) {
                return row.join(',');
            }).join('\n');
            
            downloadFile('enhanced_game_evolution_data.csv', csvContent, 'text/csv');
        }

        function exportJSON(data) {
            var jsonContent = JSON.stringify(data, null, 2);
            downloadFile('enhanced_game_evolution_data.json', jsonContent, 'application/json');
        }

        function downloadFile(filename, content, mimeType) {
            var blob = new Blob([content], { type: mimeType });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function generateReport() {
            var sessionDuration = Date.now() - (gameState.sessionData.startTime || Date.now());
            var avgAccuracy = gameState.stats.totalClicks > 0 ? 
                (gameState.stats.successfulHits / gameState.stats.totalClicks) * 100 : 0;

            var report = '<!DOCTYPE html>\n<html>\n<head>\n    <title>Enhanced Game Evolution Analysis Report</title>\n    <style>\n        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }\n        h1, h2 { color: #333; }\n        .metric { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }\n        .highlight { background: #e8f5e9; }\n        .evolution { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }\n    </style>\n</head>\n<body>\n    <h1>Enhanced Game Evolution Research Report</h1>\n    <h2>Session Overview</h2>\n    <div class="metric evolution">\n        <strong>Game Mode:</strong> ' + gameState.mode + '<br>\n        <strong>Session Duration:</strong> ' + Math.round(sessionDuration / 1000) + ' seconds<br>\n        <strong>Final Score:</strong> ' + gameState.score + '<br>\n        <strong>Maximum Level:</strong> ' + gameState.level + '<br>\n        <strong>Evolution Features:</strong> ' + gameState.features.length + '\n    </div>\n    \n    <h2>Enhanced Performance Metrics</h2>\n    <div class="metric ' + (avgAccuracy > 90 ? 'highlight' : '') + '">\n        <strong>Accuracy:</strong> ' + avgAccuracy.toFixed(1) + '%<br>\n        <strong>Total Clicks:</strong> ' + gameState.stats.totalClicks + '<br>\n        <strong>Successful Hits:</strong> ' + gameState.stats.successfulHits + '<br>\n        <strong>Average Reaction Time:</strong> ' + gameState.stats.avgReactionTime.toFixed(0) + 'ms<br>\n        <strong>Final Harmonic Note:</strong> ' + gameState.audio.currentNote + '\n    </div>\n    \n    <h2>Sensory Evolution Analysis</h2>\n    <div class="metric">\n        <strong>Visual Mutations:</strong> ' + (settings.colorEvolution ? 'Enabled' : 'Disabled') + '<br>\n        <strong>Shape Mutations:</strong> ' + (settings.shapeMutation ? 'Enabled' : 'Disabled') + '<br>\n        <strong>Audio Harmony:</strong> ' + settings.harmonicScale + ' scale<br>\n        <strong>Color Palette:</strong> ' + settings.colorPalette + '<br>\n        <strong>Features Unlocked:</strong> ' + gameState.features.join(', ') + '\n    </div>\n    \n    <h2>Research Insights</h2>\n    <div class="metric">\n        <p>This enhanced session contributed valuable multisensory data:</p>\n        <ul>\n            <li>Adaptation rate: ' + (gameState.sessionData.adaptations.length / Math.max(sessionDuration / 60000, 1)).toFixed(2) + ' mutations per minute</li>\n            <li>Sensory integration: ' + (settings.soundEffects && settings.colorEvolution ? 'Full' : 'Partial') + '</li>\n            <li>Cognitive load: ' + (gameState.features.length > 5 ? 'High' : 'Moderate') + '</li>\n            <li>Performance trend: ' + (avgAccuracy > 80 ? 'Adaptive' : 'Learning') + '</li>\n        </ul>\n    </div>\n    \n    <p><em>Generated on ' + new Date().toLocaleString() + '</em></p>\n</body>\n</html>';
            
            downloadFile('enhanced_evolution_analysis.html', report, 'text/html');
        }

        // Enhanced Event Listeners
        function setupEventListeners() {
            document.getElementById('evolutionSpeed').addEventListener('input', function(e) {
                document.getElementById('evolutionSpeedValue').textContent = e.target.value + 'x';
            });
            
            document.getElementById('masterVolume').addEventListener('input', function(e) {
                document.getElementById('volumeValue').textContent = Math.round(e.target.value * 100) + '%';
            });
            
            document.getElementById('baseFrequency').addEventListener('input', function(e) {
                document.getElementById('frequencyValue').textContent = e.target.value + ' Hz';
            });
            
            document.getElementById('backgroundColor').addEventListener('input', updateBackgroundPreview);
        }

        // Initialize the enhanced app
        function initializeApp() {
            initializeCharts();
            updateEvolutionStatus();
            loadSavedData();
            setupEventListeners();
            updateUI();
            
            // Load saved theme
            var savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            // Load saved settings
            var savedSettings = localStorage.getItem('gameSettings');
            if (savedSettings) {
                settings = Object.assign(settings, JSON.parse(savedSettings));
            }
        }

        function loadSavedData() {
            var saved = localStorage.getItem('gameEvolutionData');
            if (saved) {
                try {
                    var data = JSON.parse(saved);
                    if (data.achievements) {
                        gameState.achievements = data.achievements;
                    }
                    if (data.completedChallenges) {
                        gameState.completedChallenges = data.completedChallenges;
                    }
                } catch (e) {
                    console.log('No valid saved data found');
                }
            }
        }

        function saveData() {
            var dataToSave = {
                achievements: gameState.achievements.slice(),
                completedChallenges: gameState.completedChallenges.slice(),
                totalSessions: (JSON.parse(localStorage.getItem('gameEvolutionData') || '{}').totalSessions || 0) + 1
            };
            localStorage.setItem('gameEvolutionData', JSON.stringify(dataToSave));
        }

        // Initialize when page loads
        window.addEventListener('load', initializeApp);
        window.addEventListener('beforeunload', saveData);
    </script>
</body>
</html>